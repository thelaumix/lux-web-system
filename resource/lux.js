/*!
 * LUX Frontend
 * (c) 2022 thelaumix
 * Released under the MIT License.
*/
const Lux=(e={},t=null)=>{let n=Object.assign({backend:"{{path_endpoint}}",socket:!0,socket_address:!1},e),a=[],l={{{plugin_array}}},r={};r.Call=(e,t=null,l=null)=>(data=null,null!=t&&(data=JSON.stringify(t)),new Promise(r=>{try{$.ajax({contentType:"application/json",data,dataType:"json",xhrFields:{withCredentials:!0},complete(e,t){let n={xhr:e,data:t,cancel:!1};for(let l of a)!0!=n.cancel&&l(n);!0!==n.cancel?r({code:e.status,data:e.responseJSON||{}}):r({code:-1,data:{error:"REJECTED_BY_MIDDLEWARE",message:"The request was rejected by a middleware instance"}})},type:l||(null!=t?"POST":"GET"),url:n.backend+"/"+e})}catch{r({code:500,data:{error:"FAILED"}})}})),r.Call.use=e=>{"function"==typeof e&&a.push(e)};let s;if(!0===n.socket){let c,i={},o=new Set,u=()=>{o=new Set;let e="",t=null;try{let a=new URL(n.socket_address||n.backend);e=a.origin,t=(a.pathname+"/socket.io").replace(/[\/]{2,}/ig,"/")}catch(l){e="/",t=(n.backend+"/socket.io").replace(/[\/]{2,}/ig,"/")}(s=io(e,{transports:["websocket"],secure:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:1/0,path:t})).on("connect",()=>{for(let e in"function"==typeof c&&c(!0,s.id),i){let t=i[e];o.has(t)||(o.add(t),s.on(e,t))}}),s.on("disconnect",()=>{"function"==typeof c&&c(!1)})};u(),r.Socket={Emit:(e,...t)=>new Promise((n,a)=>{try{s.emit(e,...t,e=>{n(e)})}catch(l){a(l)}}),On(e,t){i[e]=t;try{o.has(t)||(o.add(t),s.on(e,t))}catch(n){}},Connection(e){c=e},Reconnect(){s.disconnect(),u()}}}let p=()=>{},g=async()=>{r.Page.Path=window.location.pathname;let e=window.location.pathname.toLowerCase().split("/");e.splice(0,1),r.Page.Args=e,await p()};r.Page=async(e,t=!1)=>{if($("html").addClass("--loading"),"function"==typeof e)p=e,r.Page.Path=window.location.pathname,await g();else if("string"==typeof e){let n=e;r.Page.Path=n;let a={p_url:n},l="LUX Web System";!0!==t&&history.pushState(a,l,n),document.title=l,await g()}$("html").removeClass("--loading")},r.Page.Args=[],r.Page.Path=window.location.pathname,$("a").live("click",function(e){let t=$(this).attr("href");if("/"==t.substr(0,1))return e.preventDefault(),r.Page(t),!1}),setTimeout(function(){$(window).bind("popstate",function(e){return r.Page(location.pathname,!0),e.preventDefault(!0),!1})},200),r.Plugins={};let h=new Set;return(async()=>{let e=$("<meta>");$(document.head).prepend(e);let n=()=>{e.remove(),"function"==typeof t&&t()};if(0==Object.keys(l).length)return n();for(let a in l){let s=l[a],c=("{{path_frontend}}/js:@"+a).replace(/[\/]{2,}/ig,"/");(2&s)>0&&(async()=>{h.add(a);try{let e={Page:r.Page,Plugins:r.Plugins,Socket:r.Socket,Call:(e,t=null,n=null)=>"/"==e[0]?r.Call(e,t,n):r.Call(`@/${a}/${e}`)};e.Call.use=r.Call.use;let t=await import(c+".js"),l=await t.Enable(e);r.Plugins[a]=l}catch(s){console.error("Failed to load plugin '"+a+"':",s)}h.delete(a),0==h.size&&n()})(),(1&s)>0&&$(document.head).prepend($("<link>",{rel:"stylesheet",href:c+".css"}))}})(),r};Math.clamp=function(e,t,n){return n<e?e:n>t?t:n},Math.lerp=function(e,t,n){return e+(t-e)*n},window.QueryMatchUrl=(e,t)=>{if("string"!=typeof e||"string"!=typeof t)return!1;"/"==e[0]&&(e=e.substring(1)),"/"==t[0]&&(t=t.substring(1)),"/"==e.substring(e.length-1)&&(e=e.substring(0,e.length-1)),"/"==t.substring(t.length-1)&&(t=t.substring(0,t.length-1));try{if(RegExp(`^${t}$`).test(e))return!0}catch(n){return!1}let a=e.split("/"),l=t.split("/");if(a.length!=l.length)return!1;let r=0,s={};for(let c=0;c<l.length;c++)try{let i=/:([a-z]+)(\(([^\)]+)\))?/ig.exec(l[c]);if(null!=i){if(null==i[3])s[i[1]]=a[c],r++;else{let o=RegExp(`^${i[3]}$`).exec(a[c]);null!=o&&(s[i[1]]=o[0],r++)}}else l[c]==a[c]&&r++}catch(u){return!1}return r==a.length&&(s=={}||s)},window.Wait=e=>new Promise(t=>{setTimeout(function(){t()},e)});